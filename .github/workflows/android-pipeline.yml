# GitHub Actions Workflow for Android Build Pipeline
# Complete pipeline with all stages (tests won't break the build)

name: Android Build Pipeline

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
    paths:
      - 'lib/**'
      - 'android/**'
      - 'pubspec.yaml'
      - '.github/workflows/android-pipeline.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'lib/**'
      - 'android/**'
      - 'pubspec.yaml'
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: false
        type: choice
        options:
          - patch
          - minor
          - major
        default: patch

jobs:
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.0'
          channel: 'stable'
          cache: true

      - name: Check for outdated dependencies
        continue-on-error: true
        run: |
          chmod +x scripts/update_dependencies.sh || true
          ./scripts/update_dependencies.sh || echo "âš ï¸  Dependency update failed, continuing..."

      - name: Upload dependency report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-dependency-report
          path: |
            dependency_update_report.md
            dependency_check.txt
            security_audit_dependencies.txt
          retention-days: 7
          if-no-files-found: ignore

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: update-dependencies
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.0'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run Flutter analyze
        continue-on-error: true
        run: |
          flutter analyze || echo "âš ï¸  Flutter analyze found issues, continuing..."

      - name: Run Flutter test
        continue-on-error: true
        run: |
          flutter test --coverage || echo "âš ï¸  Tests failed, continuing..."

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-test-results
          path: |
            test-results/
            coverage/
          retention-days: 7
          if-no-files-found: ignore

  code-coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: test
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.0'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Generate coverage report
        continue-on-error: true
        run: |
          flutter test --coverage || echo "âš ï¸  Coverage generation failed, continuing..."
          lcov --summary coverage/lcov.info || echo "âš ï¸  Coverage summary failed, continuing..."

      - name: Upload coverage to Codecov
        if: always()
        continue-on-error: true
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage/lcov.info
          flags: android
          name: android-coverage
          fail_ci_if_error: false

      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-coverage
          path: coverage/
          retention-days: 7
          if-no-files-found: ignore

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: update-dependencies
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.0'
          channel: 'stable'
          cache: true

      - name: Security Scan
        continue-on-error: true
        run: |
          echo "ðŸ”’ Running security scan..."
          chmod +x scripts/security_scan.sh || true
          ./scripts/security_scan.sh || echo "âš ï¸  Security scan failed, continuing..."

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-security-reports
          path: |
            security/
            security_audit_dependencies.txt
          retention-days: 7
          if-no-files-found: ignore

  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    needs: [test, code-coverage, security-scan]
    if: |
      (github.event_name != 'pull_request' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/tags/v'))) ||
      (github.event_name == 'workflow_dispatch')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.0'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Generate SBOM
        continue-on-error: true
        run: |
          echo "ðŸ“‹ Generating SBOM..."
          chmod +x scripts/generate_sbom.sh || true
          ./scripts/generate_sbom.sh || echo "âš ï¸  SBOM generation failed, continuing..."

      - name: Build APK
        run: flutter build apk --release --dart-define=PRODUCTION=true

      - name: Build AAB
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
        run: flutter build appbundle --release --dart-define=PRODUCTION=true

      - name: Get version
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
          VERSION_NUMBER=$(echo $VERSION | cut -d'+' -f1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_number=$VERSION_NUMBER" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Rename APK
        run: |
          VERSION="${{ steps.version.outputs.version_number }}"
          if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            mv build/app/outputs/flutter-apk/app-release.apk "build/app/outputs/flutter-apk/azuredevops-$VERSION.apk"
          fi

      - name: Sign APK with Sigstore
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
        continue-on-error: true
        run: |
          echo "ðŸ” Signing APK with Sigstore..."
          if command -v cosign &> /dev/null; then
            chmod +x scripts/sign_artifact.sh || true
            ./scripts/sign_artifact.sh "build/app/outputs/flutter-apk/azuredevops-${{ steps.version.outputs.version_number }}.apk" || echo "âš ï¸  Sigstore signing skipped (authentication required)"
          else
            echo "âš ï¸  cosign not installed. Sigstore signing will be skipped."
          fi

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: |
            build/app/outputs/flutter-apk/azuredevops-*.apk
            build/app/outputs/flutter-apk/azuredevops-*.apk.sigstore
          retention-days: 30

      - name: Upload AAB artifact
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

      - name: Upload SBOM artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-sbom
          path: |
            build/sbom/
          retention-days: 30
          if-no-files-found: ignore

  create-release:
    name: Create GitHub Release (Android)
    runs-on: ubuntu-latest
    needs: build-android
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine tag name
        id: tag
        run: |
          if startsWith(github.ref, 'refs/tags/v'); then
            TAG_NAME=${GITHUB_REF#refs/tags/}
            echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          else
            VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | tr -d ' ' | cut -d'+' -f1)
            TAG_NAME="v$VERSION"
            echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          fi
          echo "Using tag: $TAG_NAME"

      - name: Get version
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
          VERSION_NUMBER=$(echo $VERSION | cut -d'+' -f1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_number=$VERSION_NUMBER" >> $GITHUB_OUTPUT

      - name: Download Android artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: release-assets/android/

      - name: Download Android AAB
        uses: actions/download-artifact@v4
        with:
          name: android-aab
          path: release-assets/android/
          if-no-files-found: ignore

      - name: Download SBOM
        uses: actions/download-artifact@v4
        with:
          name: android-sbom
          path: release-assets/
          if-no-files-found: ignore

      - name: Generate release notes
        run: |
          TAG_NAME="${{ steps.tag.outputs.tag_name }}"
          VERSION="${{ steps.version.outputs.version_number }}"
          
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            CHANGELOG=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%an)" | head -30)
          else
            CHANGELOG=$(git log --pretty=format:"- %s (%an)" -20)
          fi
          
          NOTES="## ðŸš€ Android Build - $TAG_NAME
          
          ### ðŸ“¦ Version: $VERSION
          
          ### ðŸ“¥ Downloads
          - **APK**: [azuredevops-$VERSION.apk](https://github.com/${{ github.repository }}/releases/download/$TAG_NAME/azuredevops-$VERSION.apk)
          - **AAB**: [azuredevops-$VERSION.aab](https://github.com/${{ github.repository }}/releases/download/$TAG_NAME/azuredevops-$VERSION.aab)
          
          ### ðŸ“± Installation
          - **Android APK**: Download and install directly on Android devices
          - **Android AAB**: Upload to Google Play Console for distribution
          
          ### ðŸ”§ Build Information
          - **Flutter Version**: 3.27.0
          - **Build Date**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          - **Commit**: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          
          ### ðŸ“ Changes
          $CHANGELOG"
          
          echo "$NOTES" > release-notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: Android Release ${{ steps.tag.outputs.tag_name }}
          body_path: release-notes.md
          files: |
            release-assets/android/azuredevops-*.apk
            release-assets/android/azuredevops-*.apk.sigstore
            release-assets/android/app-release.aab
            release-assets/spdx.json
            release-assets/sbom.txt
          draft: false
          prerelease: false
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

